<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>简化OCR测试 - 最高置信度选择</title>
    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .info-box h3 {
            margin: 0 0 10px 0;
            color: #1976D2;
        }
        .info-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .test-case {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
            background: #f9f9f9;
        }
        canvas {
            border: 1px solid #ccc;
            display: block;
            margin: 10px auto;
            background: white;
        }
        .result {
            margin-top: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 14px;
        }
        .candidates {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 12px;
        }
        .candidate {
            display: inline-block;
            margin: 2px;
            padding: 3px 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .candidate.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: bold;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 20px auto;
            display: block;
        }
        button:hover {
            background: #45a049;
        }
        .success { color: #4CAF50; font-weight: bold; }
        .failure { color: #f44336; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 简化OCR测试 - 最高置信度选择</h1>
        
        <div class="info-box">
            <h3>📋 优化策略</h3>
            <ul>
                <li>✅ 预处理：白底黑字标准化</li>
                <li>✅ 从所有候选字母中选择置信度最高的</li>
                <li>❌ 不再使用增强对比度（已移除）</li>
                <li>✅ 如果第一次失败，尝试不同的PSM模式</li>
            </ul>
        </div>
        
        <button onclick="runTest()">运行测试</button>
        
        <div id="testGrid" class="test-grid"></div>
    </div>

    <script>
        const testLetters = ['A', 'E', 'I', 'O', 'T', 'L', 'R', 'S', 'N', 'B'];
        
        // 创建测试字母图像（白底黑字）
        function createLetterImage(letter, size = 60) {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            
            // 白色背景
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, size, size);
            
            // 黑色字母
            ctx.fillStyle = 'black';
            ctx.font = `bold ${size * 0.7}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(letter, size / 2, size / 2);
            
            return canvas;
        }
        
        // 简化的OCR识别（模拟主代码逻辑）
        async function recognizeWithHighestConfidence(canvas, targetLetter) {
            try {
                // 第一次识别：PSM_SINGLE_CHAR
                const result = await Tesseract.recognize(
                    canvas,
                    'eng',
                    {
                        logger: m => {},
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                        tessedit_pageseg_mode: '10', // PSM_SINGLE_CHAR
                        tessedit_ocr_engine_mode: '3', // DEFAULT
                        classify_bln_numeric_mode: '0',
                        tessedit_single_match: '0',
                    }
                );
                
                // 收集所有候选字母及其置信度
                const candidates = {};
                let bestLetter = '';
                let bestConfidence = 0;
                
                if (result.data.symbols && result.data.symbols.length > 0) {
                    result.data.symbols.forEach(symbol => {
                        const cleanText = symbol.text.trim().toUpperCase();
                        if (/^[A-Z]$/.test(cleanText)) {
                            candidates[cleanText] = Math.max(
                                candidates[cleanText] || 0,
                                symbol.confidence
                            );
                            
                            if (symbol.confidence > bestConfidence) {
                                bestLetter = cleanText;
                                bestConfidence = symbol.confidence;
                            }
                        }
                    });
                }
                
                // 如果没有找到字母，尝试PSM_RAW_LINE模式
                if (!bestLetter) {
                    const result2 = await Tesseract.recognize(
                        canvas,
                        'eng',
                        {
                            logger: m => {},
                            tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                            tessedit_pageseg_mode: '13', // PSM_RAW_LINE
                            tessedit_ocr_engine_mode: '3',
                        }
                    );
                    
                    if (result2.data.symbols && result2.data.symbols.length > 0) {
                        result2.data.symbols.forEach(symbol => {
                            const cleanText = symbol.text.trim().toUpperCase();
                            if (/^[A-Z]$/.test(cleanText)) {
                                candidates[cleanText] = Math.max(
                                    candidates[cleanText] || 0,
                                    symbol.confidence
                                );
                                
                                if (symbol.confidence > bestConfidence) {
                                    bestLetter = cleanText;
                                    bestConfidence = symbol.confidence;
                                }
                            }
                        });
                    }
                }
                
                return {
                    recognized: bestLetter || '?',
                    confidence: Math.round(bestConfidence),
                    candidates: candidates,
                    correct: bestLetter === targetLetter
                };
                
            } catch (error) {
                console.error('OCR错误:', error);
                return {
                    recognized: '?',
                    confidence: 0,
                    candidates: {},
                    correct: false,
                    error: error.message
                };
            }
        }
        
        // 运行测试
        async function runTest() {
            const gridDiv = document.getElementById('testGrid');
            gridDiv.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">⏳ 正在测试，请稍候...</p>';
            
            const results = [];
            
            for (const letter of testLetters) {
                const canvas = createLetterImage(letter);
                const result = await recognizeWithHighestConfidence(canvas, letter);
                results.push({ letter, ...result });
                
                // 创建结果显示
                const testDiv = document.createElement('div');
                testDiv.className = 'test-case';
                
                // 生成候选列表HTML
                let candidatesHTML = '';
                if (Object.keys(result.candidates).length > 0) {
                    const sortedCandidates = Object.entries(result.candidates)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5); // 显示前5个候选
                    
                    candidatesHTML = '<div class="candidates"><strong>候选字母：</strong><br>';
                    sortedCandidates.forEach(([char, conf]) => {
                        const isSelected = char === result.recognized;
                        candidatesHTML += `<span class="candidate ${isSelected ? 'selected' : ''}">${char}: ${Math.round(conf)}%</span>`;
                    });
                    candidatesHTML += '</div>';
                }
                
                testDiv.innerHTML = `
                    <h4>目标: ${letter}</h4>
                    ${canvas.outerHTML}
                    <div class="result">
                        <div class="${result.correct ? 'success' : 'failure'}">
                            识别: ${result.recognized} ${result.correct ? '✅' : '❌'}
                        </div>
                        <div>置信度: ${result.confidence}%</div>
                    </div>
                    ${candidatesHTML}
                `;
                
                gridDiv.appendChild(testDiv);
            }
            
            // 计算统计
            const correctCount = results.filter(r => r.correct).length;
            const accuracy = (correctCount / results.length * 100).toFixed(1);
            const avgConfidence = (results.reduce((sum, r) => sum + r.confidence, 0) / results.length).toFixed(1);
            
            // 显示总结
            const summaryDiv = document.createElement('div');
            summaryDiv.style.gridColumn = '1/-1';
            summaryDiv.className = 'info-box';
            summaryDiv.style.marginTop = '20px';
            summaryDiv.innerHTML = `
                <h3>📊 测试结果</h3>
                <ul>
                    <li>准确率: <strong>${accuracy}%</strong> (${correctCount}/${results.length})</li>
                    <li>平均置信度: <strong>${avgConfidence}%</strong></li>
                    <li>识别策略: 选择所有候选中置信度最高的字母</li>
                </ul>
                ${accuracy >= 90 ? '<p style="color: #4CAF50;">✅ 识别效果良好！</p>' : 
                  accuracy >= 70 ? '<p style="color: #FFC107;">⚠️ 识别效果一般，可能需要进一步优化</p>' :
                  '<p style="color: #f44336;">❌ 识别效果较差，建议检查预处理</p>'}
            `;
            
            gridDiv.appendChild(summaryDiv);
        }
    </script>
</body>
</html>